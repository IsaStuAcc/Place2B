import streamlit as st
import pandas as pd
from math import sin, cos, sqrt, atan2, radians

# Tab Title
st.set_page_config(page_title="Place2B", page_icon=":house:")

# Title & Intro
st.title("Place2B")
st.write("""
Find the ideal place to live that takes your desired commute into account and meets your tax requirements. :)
""")

# Einlesen der CSV-Datei mit Steuersätzen
try:
    # Der Pfad zur hochgeladenen Datei
    dateipfad = "/mnt/data/estv_income_rates_Switzerland_kurzversion.csv"
    df_geo_daten = pd.read_csv(dateipfad, delimiter=";")
    if df_geo_daten.empty:
        st.error("Die CSV-Datei ist leer. Bitte überprüfe den Inhalt der Datei.")
    else:
        st.success("Daten erfolgreich geladen!")
except Exception as e:
    st.error(f"Ein Fehler ist beim Einlesen der CSV-Datei aufgetreten: {e}")

# Importieren von mathematischen Funktionen
from math import sin, cos, sqrt, atan2, radians

# Definition der Luftdistanzfunktion
def luftdistanz(lat1, lon1, lat2, lon2):
    # approximate radius of earth in km
    R = 6371.0

    lat1 = radians(lat1)
    lon1 = radians(lon1)
    lat2 = radians(lat2)
    lon2 = radians(lon2)

    dlon = lon2 - lon1
    dlat = lat2 - lat1

    a = sin(dlat / 2) ** 2 + cos(lat1) * cos(lat2) * sin(dlon / 2) ** 2
    c = 2 * atan2(sqrt(a), sqrt(1 - a))

    distance = R * c

    return distance

# Text Input User -> Arbeitsort & Kilometerdistanz
st.subheader("Arbeitsort bestimmen")
arbeit = st.text_input("In welcher Gemeinde arbeiten Sie?", placeholder="Gemeindename...")

st.subheader("Wie weit entfernt von ihrem Arbeitsort möchten sie wohnen?")
dist_km = st.text_input("Distanz zum Arbeitsort (Angabe in km)", placeholder="Distanz...")

# Umwandlung der Distanz-Eingabe in einen numerischen Wert
try:
    dist_km = float(dist_km)
except ValueError:
    st.write("Bitte geben Sie eine gültige Zahl für die Distanz ein.")
    dist_km = None

# Berechnung und Ausgabe der Gemeinden, die innerhalb des Radius sind
if dist_km is not None and not df_geo_daten.empty:
    try:
        arbeitsort_lat = df_geo_daten[df_geo_daten["Ortschaftsname"].str.lower() == arbeit.lower()]["N"].iloc[0]
        arbeitsort_lon = df_geo_daten[df_geo_daten["Ortschaftsname"].str.lower() == arbeit.lower()]["E"].iloc[0]
        
        df_geo_daten["Distanz"] = df_geo_daten.apply(
            lambda row: luftdistanz(arbeitsort_lat, arbeitsort_lon, row["N"], row["E"]), axis=1)
        
        nahe_orte = df_geo_daten[df_geo_daten["Distanz"] <= dist_km]
        
        if not nahe_orte.empty:
            # Sortieren der Orte nach dem Steuersatz (aufsteigend)
            nahe_orte_sorted_by_tax = nahe_orte.sort_values(by="Steuersatz", ascending=True)
            st.write(f"Orte innerhalb von {dist_km} km Entfernung zu {arbeit}, sortiert nach dem Steuersatz:")
            st.dataframe(nahe_orte_sorted_by_tax[["Ortschaftsname", "Distanz", "Steuersatz"]])
        else:
            st.write("Keine Orte gefunden, die innerhalb der angegebenen Distanz liegen.")
    except IndexError:
        st.write("Arbeitsort nicht gefunden. Bitte überprüfen Sie die Eingabe.")
